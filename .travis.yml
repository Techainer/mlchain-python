language: python
arch:
  - amd64

# install:
#   - sudo apt update
#   - sudo apt install software-properties-common
#   - sudo apt update
#   - sudo apt install --no-install-recommends build-essential gcc wget git
#   - wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add -
#   - sudo apt-add-repository 'deb https://apt.kitware.com/ubuntu/ bionic main'
#   - sudo apt update && sudo apt install --no-install-recommends cmake

stages:
  - sanity_check
  - build
  - test
  - name: deploy
    if: branch = master

jobs:
  include:
    - stage: sanity_check
      name: "Sanity check"
      python: 3.7
      install:
        - pip install -U pylint pylint-exit 
      script:
        - pylint --output-format=text *.py || pylint-exit $? 
    - stage: build
      name: "Build"
      python: 3.7
      install:
        - pip install -U scikit-build awscli pip
        - pip install -U -r requirements.txt
      script:
        - python setup.py bdist_wheel
        - python setup.py install
    - stage: test
      name: "Test"
      python: 3.7
      install:
        - pip install -U scikit-build pytest coverage codecov pip
        - pip install -U attrs
      script:
        - pip install .
        - pytest --version
        - python -m coverage run --source=. -m unittest discover
        - python -m coverage report
      after_success:
        - codecov
